---
// src/pages/index.astro
import MainLayout from '../layouts/MainLayout.astro';
import { getCollection } from 'astro:content';
import { varianKopi } from '../data/kopi'; 
import '../styles/home.css';

// 1. Ambil 3 artikel terbaru dengan pengamanan data
const semuaArtikel = await getCollection('artikel');
const artikelTerbaru = semuaArtikel
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, 3);

// Logika Pengelompokan Kategori E-commerce
const categories = ["Biji Kopi", "Kopi Bubuk", "Cemilan", "Alat Seduh"];
// Filter produk baru untuk trigger pop-up
const produkBaru = varianKopi.find(k => k.isNew);
---

<MainLayout title="Lakoffie | Kopi Bubuk Murni">

<!---Baru -->

<header class="hero">
  <div class="hero-content">
    <span class="badge">Kopi Bubuk Murni</span>
    <h1 class="glare-text">Nikmati Pengalaman Kopi <br/><span>Dari Seduhan Pertama</span></h1>
    
    <div class="marketing-hook">
      <p class="hero-intro-bold">Koleksi biji kopi pilihan dan alat seduh berkualitas.</p>
      <div class="cta-wrapper">
        <a href="#shop-now" class="btn-gold">Mulai Belanja</a>
      </div>
    </div>
  </div>
</header>

<section class="products-ecommerce" id="shop-now">
  <div class="container">
    {categories.map((cat) => {
      // Filter produk berdasarkan kategori saat ini
      const produkKategori = varianKopi.filter(item => item.kategori === cat);
      
      // Hanya tampilkan section jika ada produk di kategori tersebut
      if (produkKategori.length === 0) return null;

      return (
        <div class="category-block">
          <div class="category-header">
            <h2>{cat}</h2>
            <div class="line"></div>
          </div>

          <div class="product-grid">
            {produkKategori.map((v) => (
              <div class="product-card">
                {v.hargaPromo && <div class="promo-ribbon">PROMO</div>}
                <div class="card-image">
                   <img src={v.image} alt={v.alt} loading="lazy" />
                   <div class="pure-badge">{cat === "Alat Seduh" ? "Original" : "100% Pure"}</div>
                </div>
                <div class="card-info">
                  <span class="series-label">{cat}</span>
                  <h3>{v.nama}</h3>
                  <p class="karakter">{v.karakter}</p>
                  <div class="price-wrapper">
                    {v.hargaPromo ? (
                      <div class="promo-price-stack">
                        <span class="old-price">{v.harga}</span>
                        <span class="price-promo">{v.hargaPromo}</span>
                      </div>
                    ) : (
                      <span class="price">{v.harga}</span>
                    )}
                  </div>
                  <div class="product-actions">
                    <a href={`/produk/${v.slug}/`} class="btn-outline">Detail</a>
                    <a href={`https://wa.me/6285175285640?text=Halo Lakoffie, saya ingin pesan ${v.nama}`} class="btn-gold">Beli</a>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    })}
  </div>
</section>

<section class="market">
  <h3>Dapatkan Secara Online</h3>
  <div class="market-links">
    <a href="https://www.shopee.co.id/Lakoffie">Shopee</a>
    <a href="https://www.tokopedia.com/Lakoffie">Tokopedia</a>
    <a href="https://www.tiktok.com/@lakoffie_">TikTok Shop</a>
  </div>
  <div class="mitra-cta">
    <p>Ingin merasakan langsung atau ambil di tempat?</p>
    <a href="/mitra" class="btn-mitra-luxury">Cek Lokasi Mitra üìç</a>
  </div>
</section>
<section class="home-journal">
  <div class="container">
    <div class="journal-header">
      <div>
        <span class="badge">Journal</span>
        <h2>Wawasan & <span class="gold-text italic">Inspirasi</span></h2>
      </div>
      <a href="/artikel" class="btn-text-gold">Buka Arsip ‚Üí</a>
    </div>

    <div class="journal-preview-grid">
      {artikelTerbaru.map((post) => (
        <article class="luxury-journal-card">
          <div class="journal-visual">
            <img src={post.data.image} alt={post.data.alt} loading="lazy" />
            <div class="journal-tag-float">{post.data.tags?.[0] || 'Coffee'}</div>
          </div>
          <div class="journal-body">
            <h3>{post.data.title}</h3>
            <p>{post.data && "description" in post.data 
    ? (post.data as any).description.substring(0, 95) + "..." 
    : "Jelajahi wawasan menarik seputar dunia kopi murni Lakoffie selengkapnya di sini."}</p>
            <div class="journal-footer">
              <a href={`/artikel/${post.slug || post.id}`} class="link-explore">
                Jelajahi Cerita
              </a>
            </div>
          </div>
        </article>
      ))}
    </div>
  </div>
</section>

{produkBaru && (
  <div id="newProductModal" class="modal-overlay">
    <div class="modal-content">
      <button id="closeModal" class="close-btn">&times;</button>
      <div class="modal-grid">
        <div class="modal-visual">
          <img src={produkBaru.image} alt={produkBaru.alt} class="modal-img" />
        </div>
        <div class="modal-body">
          <span class="gold-label">Eksklusif Terbaru</span>
          <h2>{produkBaru.nama}</h2>
          <p>{produkBaru.karakter}</p>
          <a href={`/produk/${produkBaru.slug}`} class="btn-primary-modal">Lihat Detail</a>
        </div>
      </div>
    </div>
  </div>
)}

  <section class="testi">
     <h2>Apa Kata Penikmat?</h2>
     <div class="testi-grid">
        <div class="testi-card"><p>Aromanya beda... Gula jawa-nya kerasa banget.</p><cite>‚Äî Budi Santoso</cite></div>
        <div class="testi-card"><p>Kualitas kopi caf√© tapi bisa bikin sendiri di rumah.</p><cite>‚Äî Sarah Wijaya</cite></div>
        <div class="testi-card"><p>Layanan WA-nya ramah, konsultasi dulu sebelum beli.</p><cite>‚Äî Andi Pratama</cite></div>
     </div>
  </section>

  
  {produkBaru && (
    <div id="newProductModal" class="modal-overlay">
      <div class="modal-content">
        <button id="closeModal" class="close-btn" aria-label="Close">&times;</button>
        <div class="modal-grid">
          <div class="modal-visual">
            <img src={produkBaru.image} alt={produkBaru.alt} class="modal-img" />
            <div class="visual-overlay"></div>
          </div>
          <div class="modal-body">
            <span class="gold-label">Eksklusif Terbaru</span>
            <h2>{produkBaru.nama}</h2>
            <div class="divider"></div>
            <p class="modal-desc">
              Rasakan simfoni rasa yang belum pernah ada sebelumnya. {produkBaru.karakter} yang diracik khusus untuk standar lidah Master.
            </p>
            <div class="modal-cta-group">
              <a href={`/produk/${produkBaru.slug}`} class="btn-primary-modal">Jelajahi Rasa</a>
              <p class="limited-tag">*Persediaan Terbatas</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  )}

</MainLayout>

<script is:inline>
  window.addEventListener('load', () => {
    const modal = document.getElementById('newProductModal');
    const closeBtn = document.getElementById('closeModal');
    const hasSeenPopup = sessionStorage.getItem('seenNewProduct');
    if (!hasSeenPopup && modal) {
      setTimeout(() => {
        modal.style.display = 'flex';
        modal.style.opacity = '1';
      }, 4000);
    }
    const handleClose = () => {
      if(modal) {
        modal.style.display = 'none';
        sessionStorage.setItem('seenNewProduct', 'true');
      }
    };
    closeBtn?.addEventListener('click', handleClose);
    window.addEventListener('click', (e) => { if (e.target === modal) handleClose(); });
  });
</script>
