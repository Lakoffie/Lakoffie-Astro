---
import MainLayout from '../../layouts/MainLayout.astro';
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  import.meta.env.SUPABASE_URL,
  import.meta.env.SUPABASE_ANON_KEY
);

const { data: dataSupabase } = await supabase
  .from('transaksi')
  .select('*')
  .order('tanggal', { ascending: false });

const dataTransaksiServer = dataSupabase || [];
---

<MainLayout title="Finance | Lakoffie">
  <link rel="stylesheet" href="/styles/admin.css" />

  <section class="admin-container">
    
    <nav class="admin-nav">
        <a href="/admin/input" class="nav-link active">üí∞ Keuangan</a>
        <a href="/admin/stok" class="nav-link">üì¶ Stok & Produksi</a>
        <a href="/admin/arsip" class="nav-link">üìÅ Arsip PDF</a>
    </nav>

    <div class="header-section" style="text-align: center; margin-bottom: 20px;">
      <h1>Buku Kas <span class="gold">Lakoffie</span></h1>
    </div>

    <div class="recap-grid">
      <div class="recap-card"><span class="label">Total Masuk</span><h2 id="totalMasuk" class="text-green">0</h2></div>
      <div class="recap-card"><span class="label">Total Keluar</span><h2 id="totalKeluar" class="text-red">0</h2></div>
      <div class="recap-card highlight"><span class="label">Saldo</span><h2 id="totalSaldo" class="gold">0</h2></div>
    </div>

    <details class="glass-card">
      <summary>‚ûï Input Transaksi Baru</summary>
      <div id="formContainer" style="margin-top:20px">
          <input type="hidden" id="editId" value="" />
          <div class="form-grid">
            <div class="form-item"><label>Tanggal</label><input type="date" id="tanggal" required /></div>
            <div class="form-item"><label>Jenis</label>
                <select id="jenis">
                <option value="Penjualan Tunai">üí∞ Penjualan Tunai</option>
                <option value="Piutang">‚è≥ Piutang</option>
                <option value="HPP">‚òï Bahan Baku (HPP)</option>
                <option value="Operasional">‚ö° Operasional</option>
                <option value="Pinjaman">üí≥ Pinjaman/Hutang</option>
                <option value="Aset">üõ†Ô∏è Alat & Aset</option>
                </select>
            </div>
            <div class="form-item full"><label>Keterangan</label><input type="text" id="keterangan" placeholder="Contoh: Beli Susu" /></div>
            <div class="form-item"><label>Masuk (Rp)</label><input type="number" id="masuk" value="0" /></div>
            <div class="form-item"><label>Keluar (Rp)</label><input type="number" id="keluar" value="0" /></div>
          </div>
          <div style="display: flex; gap: 10px;">
            <button type="button" onclick="prosesSimpan()" id="btnSimpan" class="btn-primary">SIMPAN DATA</button>
            <button type="button" onclick="cancelEdit()" id="btnCancel" class="btn-primary" style="background:#333; color:#fff; display:none;">BATAL</button>
          </div>
      </div>
    </details>

    <div class="glass-card" style="border-color: #333;">
      <div class="form-grid">
        <div class="form-item">
          <label>Dari Tanggal</label>
          <input type="date" id="filterStart" onchange="updateTampilan()" />
        </div>
        <div class="form-item">
          <label>Sampai Tanggal</label>
          <input type="date" id="filterEnd" onchange="updateTampilan()" />
        </div>
        <div class="form-item full">
          <label>Kategori Filter</label>
          <select id="filterJenis" onchange="updateTampilan()">
            <option value="Semua">Semua Kategori</option>
            <option value="Pemasukan">Hanya Pemasukan</option>
            <option value="Pengeluaran">Hanya Pengeluaran</option>
            <option value="Penjualan Tunai">Penjualan Tunai</option>
            <option value="Piutang">Piutang</option>
            <option value="HPP">HPP</option>
            <option value="Operasional">Operasional</option>
            <option value="Pinjaman">Pinjaman</option>
          </select>
        </div>
      </div>
      <button onclick="downloadData()" class="btn-download">üìÇ Download Excel (CSV)</button>
    </div>

    <div class="table-wrapper">
      <div id="data-store" data-json={JSON.stringify(dataTransaksiServer)}></div>
      <table>
        <thead>
          <tr>
            <th>Aksi</th>
            <th>Tanggal</th>
            <th>Keterangan</th>
            <th>Kategori</th>
            <th>Masuk</th>
            <th>Keluar</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

  </section>
</MainLayout>

<script is:inline>
  const dataStore = document.getElementById('data-store');
  let dataTransaksi = JSON.parse(dataStore?.getAttribute('data-json') || '[]');
  let isEditing = false;

  updateTampilan();

  function updateTampilan() {
    const tableBody = document.getElementById('tableBody');
    const fStart = document.getElementById('filterStart').value;
    const fEnd = document.getElementById('filterEnd').value;
    const fJenis = document.getElementById('filterJenis').value;

    let tMasuk = 0; let tKeluar = 0;
    tableBody.innerHTML = "";
    
    const filteredData = dataTransaksi.filter(t => {
      const matchStart = fStart ? t.tanggal >= fStart : true;
      const matchEnd = fEnd ? t.tanggal <= fEnd : true;
      let matchJenis = true;
      if (fJenis === "Pemasukan") matchJenis = t.masuk > 0;
      else if (fJenis === "Pengeluaran") matchJenis = t.keluar > 0;
      else if (fJenis !== "Semua") matchJenis = t.jenis === fJenis;
      return matchStart && matchEnd && matchJenis;
    });

    filteredData.forEach(t => {
      const masuk = Number(t.masuk) || 0;
      const keluar = Number(t.keluar) || 0;
      tMasuk += masuk; tKeluar += keluar;

      tableBody.innerHTML += `
        <tr>
          <td class="action-btns">
            <button onclick='prepEdit(${JSON.stringify(t)})' class="btn-edit">‚úèÔ∏è</button>
            <button onclick="hapusData(${t.id})" class="btn-delete">üóëÔ∏è</button>
          </td>
          <td style="white-space:nowrap">${t.tanggal}</td>
          <td><b>${t.keterangan}</b></td>
          <td><span class="badge">${t.jenis}</span></td>
          <td class="text-green">Rp ${masuk.toLocaleString()}</td>
          <td class="text-red">Rp ${keluar.toLocaleString()}</td>
        </tr>
      `;
    });

    document.getElementById('totalMasuk').innerText = `Rp ${tMasuk.toLocaleString()}`;
    document.getElementById('totalKeluar').innerText = `Rp ${tKeluar.toLocaleString()}`;
    document.getElementById('totalSaldo').innerText = `Rp ${(tMasuk - tKeluar).toLocaleString()}`;
  }

  function downloadData() {
    const headers = ["Tanggal", "Keterangan", "Jenis", "Masuk", "Keluar"];
    const rows = dataTransaksi.map(t => [t.tanggal, t.keterangan, t.jenis, t.masuk, t.keluar]);
    let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.map(e => e.join(",")).join("\n");
    const link = document.createElement("a");
    link.setAttribute("href", encodeURI(csvContent));
    link.setAttribute("download", `Laporan_Lakoffie.csv`);
    link.click();
  }

  async function prosesSimpan() {
    const id = document.getElementById('editId').value;
    const trx = {
      tanggal: document.getElementById('tanggal').value,
      keterangan: document.getElementById('keterangan').value,
      jenis: document.getElementById('jenis').value,
      masuk: parseFloat(document.getElementById('masuk').value) || 0,
      keluar: parseFloat(document.getElementById('keluar').value) || 0
    };
    if (!trx.tanggal || !trx.keterangan) return alert("Lengkapi data!");
    const res = await fetch('/api/save-transaction', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(isEditing ? { ...trx, id } : trx)
    });
    if (res.ok) location.reload();
  }

  function prepEdit(data) {
    isEditing = true;
    document.getElementById('editId').value = data.id;
    document.getElementById('tanggal').value = data.tanggal;
    document.getElementById('keterangan').value = data.keterangan;
    document.getElementById('jenis').value = data.jenis;
    document.getElementById('masuk').value = data.masuk;
    document.getElementById('keluar').value = data.keluar;
    document.getElementById('btnSimpan').innerText = "UPDATE DATA";
    document.getElementById('btnCancel').style.display = "block";
    document.querySelector('details').open = true;
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function cancelEdit() {
    isEditing = false;
    document.getElementById('editId').value = "";
    document.getElementById('btnSimpan').innerText = "SIMPAN DATA";
    document.getElementById('btnCancel').style.display = "none";
    document.getElementById('keterangan').value = "";
  }

  async function hapusData(id) {
    if (!confirm("Hapus data?")) return;
    const res = await fetch('/api/delete-transaction', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id })
    });
    if (res.ok) location.reload();
  }
</script>
