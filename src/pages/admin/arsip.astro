---
import MainLayout from '../../layouts/MainLayout.astro';
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(import.meta.env.SUPABASE_URL, import.meta.env.SUPABASE_ANON_KEY);

const { data: listArsip } = await supabase.from('arsip_dokumen').select('*').order('created_at', { ascending: false });
const { data: dataTrx } = await supabase.from('transaksi').select('*');
---

<MainLayout title="Arsip & Generator | Lakoffie">
  <link rel="stylesheet" href="/styles/admin.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" is:inline></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js" is:inline></script>

  <section class="admin-container">
    <nav class="admin-nav">
        <a href="/admin/input" class="nav-link">üí∞ Kas</a>
        <a href="/admin/stok" class="nav-link">üì¶ Stok</a>
        <a href="/admin/arsip" class="nav-link active">üìÅ Arsip PDF</a>
    </nav>

    <div id="db-data" 
         data-trx={JSON.stringify(dataTrx)} 
         data-url={import.meta.env.SUPABASE_URL}
         data-key={import.meta.env.SUPABASE_ANON_KEY}
         style="display:none"></div>

    <div class="glass-card">
      <h3>üìÑ Buat Dokumen Baru</h3>
      <div class="form-grid">
        <div class="form-item full">
          <label>Jenis Dokumen</label>
          <select id="docKategori">
            <option value="Faktur Penjualan">Faktur Penjualan</option>
            <option value="Faktur Pembelian">Faktur Pembelian</option>
            <option value="Proposal">Proposal</option>
            <option value="Laporan Keuangan">Laporan Keuangan</option>
          </select>
        </div>
        <div class="form-item"><label>Penerima</label><input type="text" id="docPenerima" placeholder="Nama Mitra" /></div>
        <div class="form-item"><label>Barang/Project</label><input type="text" id="docBarang" placeholder="Deskripsi" /></div>
        <div class="form-item full"><label>Jumlah/Nilai</label><input type="text" id="docJumlah" placeholder="Qty / Rp" /></div>
      </div>
      <button onclick="generatePDF()" id="btnGen" class="btn-primary">GENERATE & SIMPAN KE CLOUD</button>
    </div>

    <div class="header-section" style="margin-top:40px; display:flex; justify-content:space-between; align-items:center;">
      <h3>Daftar Arsip Digital</h3>
      <select id="filterKategori" onchange="filterArsip()" style="padding:8px; border-radius:8px; background:#151515; color:white; border:1px solid var(--gold); font-size: 12px;">
        <option value="Semua">Semua Kategori</option>
        <option value="Faktur Penjualan">Faktur Penjualan</option>
        <option value="Faktur Pembelian">Faktur Pembelian</option>
        <option value="Proposal">Proposal</option>
        <option value="Laporan Keuangan">Laporan Keuangan</option>
      </select>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Info Dokumen</th>
            <th>Penerima</th>
            <th style="text-align:center">Aksi</th>
          </tr>
        </thead>
        <tbody id="arsipBody">
          {listArsip?.map(doc => (
            <tr data-kat={doc.kategori}>
              <td>
                <small class="gold" style="font-size: 10px;">{doc.kategori}</small><br/>
                <b>{doc.nama_dokumen}</b><br/>
                <small style="color: #666;">{new Date(doc.created_at).toLocaleDateString('id-ID')}</small>
              </td>
              <td style="font-size: 12px;">{doc.nama_penerima || '-'}</td>
              <td>
                <div class="action-btns" style="justify-content: center;">
                    <a href={doc.file_url} target="_blank" title="Lihat" class="btn-edit" style="background: #111;">üëÅÔ∏è</a>
                    <a href={doc.file_url} download title="Download" class="btn-edit" style="background: #111;">üì•</a>
                    <button onclick={`salinLink('${doc.file_url}')`} title="Salin Link" class="btn-edit" style="background: #111;">üîó</button>
                    <button onclick={`hapusArsip(${doc.id}, '${doc.nama_dokumen}', '${doc.kategori}')`} class="btn-delete" style="background: #221111;">üóëÔ∏è</button>
                </div>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </section>
</MainLayout>

<script is:inline>
  const dbStore = document.getElementById('db-data');
  const SUPABASE_URL = dbStore.dataset.url;
  const SUPABASE_KEY = dbStore.dataset.key;

  function filterArsip() {
    const kat = document.getElementById('filterKategori').value;
    document.querySelectorAll('#arsipBody tr').forEach(tr => {
      tr.style.display = (kat === "Semua" || tr.dataset.kat === kat) ? "" : "none";
    });
  }

  function salinLink(url) {
    navigator.clipboard.writeText(url);
    alert("Link berhasil disalin! Silakan paste ke WhatsApp mitra.");
  }

  async function generatePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const btn = document.getElementById('btnGen');
    const urlTTD = "https://hlyviwpkxkrifgaapmzu.supabase.co/storage/v1/object/public/arsip-lakoffie/ttd.png";

    const kategori = document.getElementById('docKategori').value;
    const penerima = document.getElementById('docPenerima').value;
    const barang = document.getElementById('docBarang').value;
    const jumlah = document.getElementById('docJumlah').value;

    btn.disabled = true; btn.innerText = "Checking Order...";

    const resCount = await fetch(`${SUPABASE_URL}/rest/v1/arsip_dokumen?kategori=eq.${kategori}&select=id`, {
        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
    });
    const dataExist = await resCount.json();
    const nextUrut = String(dataExist.length + 1).padStart(2, '0');

    const now = new Date();
    const d = String(now.getDate()).padStart(2, '0'), m = String(now.getMonth() + 1).padStart(2, '0'), y = now.getFullYear();
    
    let kode = "DOC";
    if(kategori === "Faktur Penjualan") kode = "FKT-OUT";
    else if(kategori === "Faktur Pembelian") kode = "FKT-IN";
    else if(kategori === "Proposal") kode = "PRP";
    else if(kategori === "Laporan Keuangan") kode = "LAP";

    const noDoc = `${kode}/${nextUrut}/${d}/${m}/${y}`;
    const cleanFileName = `${kode}-${nextUrut}-${d}-${m}-${y}.pdf`;
    const storagePath = `${kategori.replace(/ /g, '_')}/${cleanFileName}`;

    doc.setFont("helvetica", "bold"); doc.setFontSize(22); doc.text("LAKOFFIE", 105, 20, {align: 'center'});
    doc.setFont("helvetica", "italic"); doc.setFontSize(10); doc.text("Kopi Bubuk Murni", 105, 26, {align: 'center'});
    doc.line(20, 30, 190, 30);
    doc.setFontSize(14); doc.text(kategori.toUpperCase(), 20, 45);
    doc.setFontSize(10); doc.setFont("helvetica", "normal");
    doc.text(`Nomor: ${noDoc}`, 20, 52);
    doc.text(`Tanggal: ${d}/${m}/${y}`, 20, 58);
    doc.text(`Penerima: ${penerima || '-'}`, 20, 64);

    if(kategori.includes("Laporan")) {
        const trx = JSON.parse(dbStore.dataset.trx);
        doc.autoTable({ startY: 72, head: [['Tgl', 'Ket', 'Masuk', 'Keluar']], 
            body: trx.map(t => [t.tanggal, t.keterangan, t.masuk, t.keluar]),
            headStyles: { fillColor: [197, 160, 89] } 
        });
    } else {
        doc.autoTable({ startY: 72, head: [['Deskripsi', 'Detail']], body: [['Barang/Project', barang], ['Nilai/Jumlah', jumlah]], headStyles: { fillColor: [197, 160, 89] } });
    }

    const finalY = (doc.lastAutoTable.finalY || 100) + 15;
    doc.text("Hormat Kami,", 150, finalY);
    try { doc.addImage(urlTTD, 'PNG', 145, finalY + 2, 30, 15); } catch(e){}
    doc.setFont("helvetica", "bold"); doc.text("LAKOFFIE", 150, finalY + 25);

    const pdfBlob = doc.output('blob');
    try {
        const up = await fetch(`${SUPABASE_URL}/storage/v1/object/arsip-lakoffie/${storagePath}`, {
            method: 'POST',
            headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/pdf' },
            body: pdfBlob
        });
        if(!up.ok) throw new Error("Gagal simpan cloud");

        const fileUrl = `${SUPABASE_URL}/storage/v1/object/public/arsip-lakoffie/${storagePath}`;
        await fetch(`${SUPABASE_URL}/rest/v1/arsip_dokumen`, {
            method: 'POST',
            headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ nama_dokumen: noDoc, kategori, nama_penerima: penerima, file_url: fileUrl })
        });

        alert("Arsip Tersimpan di Cloud!");
        location.reload();
    } catch (err) { alert(err.message); }
  }

  async function hapusArsip(id, noDoc, kategori) {
    if(!confirm(`Hapus permanen ${noDoc}?`)) return;
    const storageName = noDoc.replace(/\//g, '-') + ".pdf";
    const storagePath = `${kategori.replace(/ /g, '_')}/${storageName}`;
    try {
        await fetch(`${SUPABASE_URL}/rest/v1/arsip_dokumen?id=eq.${id}`, {
            method: 'DELETE', headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
        });
        await fetch(`${SUPABASE_URL}/storage/v1/object/arsip-lakoffie/${storagePath}`, {
            method: 'DELETE', headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
        });
        location.reload();
    } catch (err) { alert("Gagal hapus"); }
  }
</script>
