---
import MainLayout from '../../layouts/MainLayout.astro';
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(import.meta.env.SUPABASE_URL, import.meta.env.SUPABASE_ANON_KEY);

const { data: listArsip } = await supabase.from('arsip_dokumen').select('*').order('created_at', { ascending: false });
---

<MainLayout title="Arsip & Generator | Lakoffie">
  <link rel="stylesheet" href="/styles/admin.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" is:inline></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js" is:inline></script>

  <section class="admin-container">
    <nav class="admin-nav">
        <a href="/admin/input" class="nav-link">üí∞ Kas</a>
        <a href="/admin/stok" class="nav-link">üì¶ Stok</a>
        <a href="/admin/arsip" class="nav-link active">üìÅ Arsip PDF</a>
    </nav>

    <div id="db-data" 
         data-url={import.meta.env.SUPABASE_URL}
         data-key={import.meta.env.SUPABASE_ANON_KEY}
         style="display:none"></div>

    <div class="glass-card">
      <h3>üìÑ Buat Faktur Baru</h3>
      <div class="form-grid">
        <div class="form-item"><label>Jenis Dokumen</label>
          <select id="docKategori" class="input-gold">
            <option value="Faktur Penjualan">Faktur Penjualan</option>
            <option value="Faktur Pembelian">Faktur Pembelian</option>
          </select>
        </div>
        <div class="form-item"><label>Status Pembayaran</label>
            <select id="docStatus" class="input-gold">
              <option value="Lunas">‚úÖ Lunas</option>
              <option value="Belum Lunas">‚è≥ Belum Lunas (Draft)</option>
            </select>
        </div>
        <div class="form-item full"><label>Nama Penerima</label><input type="text" id="docPenerima" class="input-gold" placeholder="Contoh: Toko Kopi Jaya" /></div>
        
        <div class="form-item full">
            <label>Daftar Barang (Pisahkan dengan koma per barang)</label>
            <textarea id="docBarang" class="input-gold" rows="2" placeholder="Contoh: Robusta 250g, Arabica 500g"></textarea>
        </div>
        <div class="form-item"><label>Jumlah (Qty)</label><input type="text" id="docJumlah" class="input-gold" placeholder="Contoh: 2, 1" /></div>
        <div class="form-item"><label>Harga Satuan (Rp)</label><input type="text" id="docHarga" class="input-gold" placeholder="Contoh: 50000, 85000" /></div>
      </div>
      <button onclick="generatePDF()" id="btnGen" class="btn-primary">GENERATE & SIMPAN KE CLOUD</button>
    </div>

    <div class="header-section" style="margin-top:40px; display:flex; justify-content:space-between; align-items:center;">
      <h3>Daftar Arsip Digital</h3>
      <div style="display:flex; gap:10px;">
          <select id="filterStatus" onchange="filterArsip()" class="select-mini">
            <option value="Semua">Semua Status</option>
            <option value="Lunas">Lunas</option>
            <option value="Belum Lunas">Belum Lunas</option>
          </select>
          <select id="filterKategori" onchange="filterArsip()" class="select-mini">
            <option value="Semua">Semua Kategori</option>
            <option value="Faktur Penjualan">Penjualan</option>
            <option value="Faktur Pembelian">Pembelian</option>
          </select>
      </div>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Dokumen</th>
            <th>Penerima & Status</th>
            <th style="text-align:center">Aksi</th>
          </tr>
        </thead>
        <tbody id="arsipBody">
          {listArsip?.map(doc => (
            <tr data-kat={doc.kategori} data-status={doc.status || 'Lunas'}>
              <td>
                <small class="gold">{doc.kategori}</small><br/>
                <b>{doc.nama_dokumen}</b><br/>
                <small style="color: #666;">{new Date(doc.created_at).toLocaleDateString('id-ID')}</small>
              </td>
              <td>
                <span style="font-size: 13px;">{doc.nama_penerima || '-'}</span><br/>
                <span class={doc.status === 'Belum Lunas' ? 'badge-red' : 'badge-green'}>
                    {doc.status || 'Lunas'}
                </span>
              </td>
              <td>
                <div class="action-btns-grid">
                    <a href={doc.file_url} target="_blank" title="Lihat" class="btn-icon">üëÅÔ∏è</a>
                    <a href={doc.file_url} download title="Download" class="btn-icon">üì•</a>
                    <button onclick={`shareWA('${doc.nama_penerima}', '${doc.file_url}')`} title="Share WA" class="btn-icon">üì±</button>
                    <button onclick={`toggleStatus(${doc.id}, '${doc.status}')`} title="Ubah Status" class="btn-icon" style="background: #333;">‚úèÔ∏è</button>
                    <button onclick={`hapusArsip(${doc.id}, '${doc.nama_dokumen}', '${doc.kategori}')`} class="btn-icon btn-del-mini">üóëÔ∏è</button>
                </div>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </section>
</MainLayout>

<style>
  /* Tambahan Style khusus untuk Admin Arsip */
  .input-gold {
    width: 100%; padding: 10px; background: #111; border: 1px solid #333; color: white; border-radius: 8px; margin-top: 5px;
  }
  .input-gold:focus { border-color: var(--gold); outline: none; }
  .select-mini { padding: 8px; border-radius: 8px; background: #151515; color: white; border: 1px solid var(--gold); font-size: 11px; }
  .badge-green { background: #1b4332; color: #8ef9ad; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; }
  .badge-red { background: #431b1b; color: #f98e8e; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; }
  .action-btns-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
  .btn-icon { padding: 8px; background: #1a1a1a; border: 1px solid #333; border-radius: 6px; text-decoration: none; text-align: center; cursor: pointer; transition: 0.3s; }
  .btn-icon:hover { border-color: var(--gold); background: #222; }
  .btn-del-mini:hover { background: #431b1b; border-color: #f98e8e; }
</style>

<script is:inline>
  const dbStore = document.getElementById('db-data');
  const SUPABASE_URL = dbStore.dataset.url;
  const SUPABASE_KEY = dbStore.dataset.key;

  function filterArsip() {
    const kat = document.getElementById('filterKategori').value;
    const stat = document.getElementById('filterStatus').value;
    document.querySelectorAll('#arsipBody tr').forEach(tr => {
      const mKat = (kat === "Semua" || tr.dataset.kat === kat);
      const mStat = (stat === "Semua" || tr.dataset.status === stat);
      tr.style.display = (mKat && mStat) ? "" : "none";
    });
  }

  function shareWA(penerima, url) {
    const teks = `Halo ${penerima}, berikut adalah dokumen dari Lakoffie: ${url}`;
    window.open(`https://wa.me/?text=${encodeURIComponent(teks)}`, '_blank');
  }

  async function toggleStatus(id, currentStatus) {
    const newStatus = currentStatus === 'Belum Lunas' ? 'Lunas' : 'Belum Lunas';
    if(!confirm(`Ubah status menjadi ${newStatus}?`)) return;
    try {
        await fetch(`${SUPABASE_URL}/rest/v1/arsip_dokumen?id=eq.${id}`, {
            method: 'PATCH',
            headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus })
        });
        location.reload();
    } catch(e) { alert("Gagal ubah status"); }
  }

  async function generatePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const btn = document.getElementById('btnGen');
    const urlTTD = "https://hlyviwpkxkrifgaapmzu.supabase.co/storage/v1/object/public/arsip-lakoffie/ttd.png";

    const kategori = document.getElementById('docKategori').value;
    const status = document.getElementById('docStatus').value;
    const penerima = document.getElementById('docPenerima').value || "-";
    const barangArr = document.getElementById('docBarang').value.split(',');
    const jumlahArr = document.getElementById('docJumlah').value.split(',');
    const hargaArr = document.getElementById('docHarga').value.split(',');

    btn.disabled = true; btn.innerText = "Simpan Cloud...";

    try {
      const resCount = await fetch(`${SUPABASE_URL}/rest/v1/arsip_dokumen?kategori=eq.${kategori}&select=id`, {
          headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
      });
      const dataExist = await resCount.json();
      const nextUrut = String(dataExist.length + 1).padStart(3, '0');

      const now = new Date();
      const d = String(now.getDate()).padStart(2, '0'), m = String(now.getMonth() + 1).padStart(2, '0'), y = now.getFullYear();
      const noDoc = `${kategori === "Faktur Penjualan" ? "FKT-OUT" : "FKT-IN"}/${nextUrut}/${d}/${m}/${y}`;
      const storagePath = `${kategori.replace(/ /g, '_')}/${noDoc.replace(/\//g, '-')}.pdf`;

      // DESIGN PDF
      doc.setDrawColor(0); doc.rect(5, 5, 200, 287); // Border
      doc.setFont("helvetica", "bold"); doc.setFontSize(22); doc.text("LAKOFFIE", 105, 20, {align: 'center'});
      doc.setFont("helvetica", "italic"); doc.setFontSize(10); doc.text("Kopi Bubuk Murni", 105, 26, {align: 'center'});
      doc.line(20, 32, 190, 32);

      doc.setFontSize(14); doc.text(kategori.toUpperCase(), 20, 45);
      doc.setFontSize(10); doc.setFont("helvetica", "normal");
      doc.text(`Nomor    : ${noDoc}`, 20, 52);
      doc.text(`Status   : ${status.toUpperCase()}`, 20, 58);
      doc.text(`Penerima : ${penerima}`, 20, 64);

      const tableData = barangArr.map((b, i) => {
        const qty = parseInt(jumlahArr[i]) || 0;
        const harga = parseInt(hargaArr[i]) || 0;
        return [b.trim(), qty, `Rp ${harga.toLocaleString()}`, `Rp ${(qty * harga).toLocaleString()}`];
      });

      doc.autoTable({
        startY: 72,
        head: [['Nama Barang', 'Qty', 'Harga Satuan', 'Subtotal']],
        body: tableData,
        theme: 'grid',
        headStyles: { fillColor: [197, 160, 89] },
        foot: [[{content: 'TOTAL PEMBAYARAN', colSpan: 3, styles: {halign: 'right'}}, `Rp ${tableData.reduce((a,b) => a + parseInt(b[3].replace(/\D/g,'')), 0).toLocaleString()}`]],
        footStyles: { fillColor: [240, 240, 240], textColor: [0,0,0], fontStyle: 'bold' }
      });

      const finalY = doc.lastAutoTable.finalY + 15;
      const rightX = 145;
      doc.text(`Semarang, ${d}/${m}/${y}`, rightX, finalY);
      doc.text("Hormat Kami,", rightX, finalY + 6);
      try { doc.addImage(urlTTD, 'PNG', rightX - 5, finalY + 8, 30, 12); } catch(e){}
      doc.setFont("helvetica", "bold"); doc.text("LAKOFFIE", rightX, finalY + 25);

      const pdfBlob = doc.output('blob');
      await fetch(`${SUPABASE_URL}/storage/v1/object/arsip-lakoffie/${storagePath}`, {
          method: 'POST', headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'x-upsert': 'true' }, body: pdfBlob
      });

      const fileUrl = `${SUPABASE_URL}/storage/v1/object/public/arsip-lakoffie/${storagePath}`;
      await fetch(`${SUPABASE_URL}/rest/v1/arsip_dokumen`, {
          method: 'POST',
          headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ nama_dokumen: noDoc, kategori, nama_penerima: penerima, file_url: fileUrl, status })
      });

      alert("Faktur Berhasil Disimpan!");
      location.reload();
    } catch (err) { alert(err.message); btn.disabled = false; btn.innerText = "GENERATE"; }
  }

  async function hapusArsip(id, noDoc, kategori) {
    if(!confirm(`Hapus permanen ${noDoc}?`)) return;
    const storagePath = `${kategori.replace(/ /g, '_')}/${noDoc.replace(/\//g, '-')}.pdf`;
    try {
        await fetch(`${SUPABASE_URL}/rest/v1/arsip_dokumen?id=eq.${id}`, { method: 'DELETE', headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } });
        await fetch(`${SUPABASE_URL}/storage/v1/object/arsip-lakoffie/${storagePath}`, { method: 'DELETE', headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } });
        location.reload();
    } catch (err) { alert("Gagal hapus"); }
  }
</script>
