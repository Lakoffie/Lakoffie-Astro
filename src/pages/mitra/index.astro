---
import MainLayout from '../../layouts/MainLayout.astro';
import { daftarMitra } from '../../data/mitra';
import '../../styles/mitra.css';

const daftarWilayah = [...new Set(daftarMitra.map(m => m.wilayah))].sort();
---

<MainLayout title="Mitra Lakoffie | Store Locator">
  <section class="mitra-hero">
    <div class="container">
      <h1>Temukan <span class="gold">Lakoffie</span></h1>
      <p>Pilih wilayah atau cari lokasi terdekat.</p>
    </div>
  </section>

  <div class="container">
    <div class="wilayah-filter-wrapper">
      <div class="wilayah-filter">
        <button class="chip-wilayah active" data-filter="semua">Semua Wilayah</button>
        {daftarWilayah.map(wilayah => (
          <button class="chip-wilayah" data-filter={wilayah}>{wilayah}</button>
        ))}
      </div>
    </div>

    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Cari nama toko atau kecamatan..." />
      <button id="btnNearby" class="btn-nearby">ğŸ“ Cari Terdekat</button>
    </div>

    <div class="mitra-grid" id="mitraGrid">
      {daftarMitra.map((m) => (
        <div class="mitra-card" 
             data-nama={m.nama.toLowerCase()} 
             data-wilayah={m.wilayah}
             data-kecamatan={m.kecamatan.toLowerCase()}
             data-lat={m.lat} 
             data-lng={m.lng}>
          <div class="card-header">
            <span class="badge-wilayah">{m.wilayah}</span>
            <img src={m.image} alt={m.alt || `Lokasi Toko Mitra Lakoffie di ${m.kota}`} loading="lazy" />
          </div>
          <div class="card-body">
            <span class="jenis-tag">{m.jenis}</span>
            <h3>{m.nama}</h3>
            <p class="alamat">{m.alamat}</p>
            <div class="jarak-info"></div> 
            <div class="card-footer">
              <a href={m.gmaps} target="_blank" class="btn-gmaps">G-Maps</a>
              <a href={`/mitra/${m.id}`} class="btn-detail">Detail</a>
            </div>
          </div>
        </div>
      ))}
    </div>
  </div>

 <script is:inline>
  // --- UTILS: Hitung Jarak ---
  function hitungJarak(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
    return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
  }

  const searchInput = document.getElementById('searchInput');
  const btnNearby = document.getElementById('btnNearby');
  const grid = document.getElementById('mitraGrid');
  const chips = document.querySelectorAll('.chip-wilayah');

  function filterData() {
    const cards = document.querySelectorAll('.mitra-card');
    const activeChip = document.querySelector('.chip-wilayah.active');
    const filterWilayah = activeChip?.dataset.filter || 'semua';
    const query = searchInput.value.toLowerCase();

    cards.forEach(card => {
      const matchW = filterWilayah === 'semua' || card.dataset.wilayah === filterWilayah;
      const matchS = card.dataset.nama.includes(query) || card.dataset.kecamatan.includes(query);
      card.style.display = (matchW && matchS) ? 'block' : 'none';
    });
  }

  searchInput.addEventListener('input', filterData);
  chips.forEach(btn => {
    btn.addEventListener('click', () => {
      chips.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      filterData();
    });
  });

  // --- LOGIC GPS TERDEKAT ---
  btnNearby.addEventListener('click', () => {
    if (!navigator.geolocation) return alert("GPS tidak didukung oleh browser Anda");
    
    btnNearby.innerText = "âš¡ Mengurutkan...";

    navigator.geolocation.getCurrentPosition(pos => {
      const uLat = pos.coords.latitude;
      const uLng = pos.coords.longitude;
      
      // Ambil semua card dan ubah jadi Array agar bisa di-sort total
      const cardsArray = Array.from(document.querySelectorAll('.mitra-card'));
      let listJarak = [];

      // A. RESET FILTER (Sesuai permintaan: Abaikan wilayah)
      chips.forEach(b => b.classList.remove('active'));
      document.querySelector('[data-filter="semua"]').classList.add('active');
      searchInput.value = ""; 

      cardsArray.forEach(card => {
        card.style.display = 'block'; 
        const lat = parseFloat(card.dataset.lat);
        const lng = parseFloat(card.dataset.lng);
        
        // Default jarak sangat jauh jika data koordinat salah/rusak
        let d = 999999; 

        if (!isNaN(lat) && !isNaN(lng)) {
          d = hitungJarak(uLat, uLng, lat, lng);
          
          const box = card.querySelector('.jarak-info');
          if (box) {
            // FIX: Jika < 1km pakai meter, jika > 1km pakai km
            const teksJarak = d < 1 
              ? `ğŸ“ Sekitar ${(d * 1000).toFixed(0)} meter` 
              : `ğŸ“ Sekitar ${d.toFixed(1)} km`;
              
            box.innerHTML = `<span>${teksJarak} dari lokasi Anda</span>`;
            box.classList.add('active');
          }
        }
        listJarak.push({ card, d });
      });

      // B. SORTING TOTAL: Urutkan dari yang benar-benar terkecil (0.1, 0.2, dst)
      listJarak.sort((a, b) => a.d - b.d);

      // C. RE-ORDER DOM: Kosongkan grid lalu masukkan sesuai urutan baru
      grid.innerHTML = "";
      listJarak.forEach(item => {
        grid.appendChild(item.card);
      });

      btnNearby.innerText = "ğŸ“ Urut Terdekat";
      
      window.scrollTo({
        top: grid.offsetTop - 120,
        behavior: 'smooth'
      });

    }, (err) => {
      alert("Gagal mengambil lokasi. Pastikan GPS aktif.");
      btnNearby.innerText = "ğŸ“ Cari Terdekat";
    });
  });
</script>
</MainLayout>
